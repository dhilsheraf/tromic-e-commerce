<%- include("../partials/header.ejs") %>

<!-- Begin Main Content Area -->
<main class="main-content">
    <div class="breadcrumb-area breadcrumb-height" data-bg-image="/images/breadcrumb/bg/1-1-1920x400.jpg">
        <div class="container h-100">
            <div class="row h-100">
                <div class="col-lg-12">
                    <div class="breadcrumb-item text-night-rider">
                        <h2 class="breadcrumb-heading">My Account Page</h2>
                        <ul>
                            <li>
                                <a href="/">Home/</a>
                            </li>
                            <li>My Account</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="account-page-area section-space-y-axis-100">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <ul class="nav myaccount-tab-trigger" id="account-page-tab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="account-dashboard-tab" data-bs-toggle="tab" href="#account-dashboard" role="tab" aria-controls="account-dashboard" aria-selected="true">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="account-orders-tab" data-bs-toggle="tab" href="#account-orders" role="tab" aria-controls="account-orders" aria-selected="false">Orders</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="account-address-tab" data-bs-toggle="tab" href="#account-address" role="tab" aria-controls="account-address" aria-selected="false">Addresses</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="account-details-tab" data-bs-toggle="tab" href="#account-details" role="tab" aria-controls="account-details" aria-selected="false">Password</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="account-logout-tab" href="/logout" role="tab" aria-selected="false">Logout</a>
                        </li>
                        
                    </ul>
                </div>
                <div class="col-lg-9">
                    <div class="tab-content myaccount-tab-content" id="account-page-tab-content">
                        <div class="tab-pane fade show active" id="account-dashboard" role="tabpanel" aria-labelledby="account-dashboard-tab">
                            <div class="myaccount-dashboard text-center">
                                <p style="color: black;">Your account details:</p>
                                <ul>
                                    <li style="color: black;">Username: <%= user.username %></li>
                                    <li style="color: black;">Email: <%= user.email %></li>
                                    <li style="color: black;">Phone Number: <%= user.number %></li>
                                </ul>
                                <p>
                                    <br>
                                    <a href="#" id="editProfileButton" class="btn btn-custom-size lg-size btn-primary">Edit Profile</a>
                                </p>
                            </div>
                        </div>                        
                        
                        <div class="tab-pane fade" id="account-orders" role="tabpanel" aria-labelledby="account-orders-tab">
                            <div class="myaccount-orders">
                                <h4 class="small-title">MY ORDERS</h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <tbody>
                                            <tr>
                                                <th>ORDER</th>
                                                <th>DATE</th>
                                                <th>STATUS</th>
                                                <th>TOTAL</th>
                                                <th></th>
                                            </tr>
                                            <tr>
                                                <td><a class="account-order-id" href="#">#5364</a></td>
                                                <td>Mar 27, 2019</td>
                                                <td>On Hold</td>
                                                <td>$162.00 for 2 items</td>
                                                <td><a href="#" class="btn btn-dark btn-primary-hover"><span>View</span></a>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><a class="account-order-id" href="#">#5356</a></td>
                                                <td>Mar 27, 2019</td>
                                                <td>On Hold</td>
                                                <td>$162.00 for 2 items</td>
                                                <td><a href="#" class="btn btn-dark btn-primary-hover"><span>View</span></a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="account-address" role="tabpanel" aria-labelledby="account-address-tab">
                            <div class="myaccount-address">
                                <p>The following addresses will be used on the checkout page by default.</p>
                                <div id="address-list" class="row">
                                    <!-- Dynamically render addresses here -->
                                    <% addresses.forEach(address => { %>
                                        <div class="col-12 col-md-6 mb-3">
                                            <div class="address-card p-3 border rounded">
                                                <h4 class="small-title"><%= address.addressType %> Address</h4>
                                                <address>
                                                    <strong>Full name:</strong> <%= address.name %><br>
                                                    <strong>Phone:</strong> <%= address.phone %><br>
                                                    <strong>Pincode:</strong> <%= address.pincode %><br>
                                                    <strong>Address:</strong> <%= address.addressLine %>, <%= address.pincode %>, <%= address.city %>, <%= address.state %>, <%= address.country %>
                                                </address>
                                                <div class="d-flex justify-content-between">
                                                    <button class="btn btn-primary btn-sm edit-address-btn" data-id="<%= address._id %>">Edit</button>
                                                    <button class="btn btn-danger btn-sm delete-address-btn" data-id="<%= address._id %>">Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                </div>
                                <button id="addAddressButton" class="btn btn-primary mt-3">Add Address</button>
                            </div>
                        </div>
                        
                        
                        <div class="tab-pane fade" id="account-details" role="tabpanel" aria-labelledby="account-details-tab">
                            <div class="myaccount-details">
                                <form action="#" class="myaccount-form">
                                    <div class="myaccount-form-inner">
                                        <div class="single-input">
                                            <label>Current Password</label>
                                            <input type="password" >
                                        </div>
                                        <div class="single-input">
                                            <label>New Password </label>
                                            <input type="password">
                                        </div>
                                        <div class="single-input">
                                            <label>Confirm New Password</label>
                                            <input type="password">
                                        </div>
                                        <div class="single-input">
                                            <button class="btn btn-custom-size lg-size btn-primary" type="submit">
                                                <span>SAVE CHANGES</span>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm" action="#" method="POST">
                        <div class="myaccount-form-inner">
                            <div class="single-input">
                                <label for="username">Username*</label>
                                <br>
                                <input type="text" class="form-control id="username" name="username" value="<%= user.username %>" required>
                            </div>
                            <div class="single-input">
                                <label for="number">Phone Number</label>
                                <br>
                                <input type="text" class="form-control" id="number" name="number" value="<%= user.number %>">
                            </div>
                            <br>
                            <div class="single-input">
                                <button class="btn btn-custom-size lg-size btn-primary w-100" type="submit">
                                    <span>Save Changes</span>
                                </button>
                            </div>
                        </div>
                    </form>                    
                </div>
            </div>
        </div>
    </div>
    <!-- Address Modal -->
<!-- Modal for Add Address -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAddressForm">
                    <div class="single-input">
                        <label for="name">Full Name*</label>
                        <input type="text" name="name" id="name" class="form-control" placeholder="Enter Full Name" required>
                    </div>
                    <div class="single-input">
                        <label for="phone">Phone Number*</label>
                        <input type="text" name="phone" id="phone" class="form-control" placeholder="Enter Phone Number" required>
                    </div>
                    <div class="single-input">
                        <label for="addressType">Address Type*</label>
                        <select id="addressType" name="addressType" class="form-control" required>
                            <option value="Home">Home</option>
                            <option value="Work">Work</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="single-input">
                        <label for="pincode">Pincode*</label>
                        <input type="text" name="pincode" id="pincode" class="form-control" placeholder="Enter Pincode" required>
                    </div>
                    <div class="single-input">
                        <label for="addressLine">Address*</label>
                        <input type="text" id="addressLine" name="addressLine" class="form-control" placeholder="Enter Address" required>
                    </div>
                    <div class="single-input">
                        <label for="city">City*</label>
                        <input type="text" id="city" name="city" class="form-control" placeholder="Enter City" required>
                    </div>
                    <div class="single-input">
                        <label for="state">State*</label>
                        <input type="text" name="state" id="state" class="form-control" placeholder="Enter State" required>
                    </div>
                    <div class="single-input">
                        <label for="country">Country*</label>
                        <input type="text" id="country" name="country" class="form-control" placeholder="Enter Country" required>
                    </div>
                    <div class="single-input">
                        <button type="submit" class="btn btn-primary w-100">Save Address</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Edit Address -->
<div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAddressForm">
                    <div class="single-input">
                        <label for="editName">Full Name*</label>
                        <input type="text" name="name" id="editName" class="form-control" placeholder="Enter Full Name" required>
                    </div>
                    <div class="single-input">
                        <label for="editPhone">Phone Number*</label>
                        <input type="text" name="phone" id="editPhone" class="form-control" placeholder="Enter Phone Number" required>
                    </div>
                    <div class="single-input">
                        <label for="editAddressType">Address Type*</label>
                        <select id="editAddressType" name="addressType" class="form-control" required>
                            <option value="Home">Home</option>
                            <option value="Work">Work</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="single-input">
                        <label for="editPincode">Pincode*</label>
                        <input type="text" name="pincode" id="editPincode" class="form-control" placeholder="Enter Pincode" required>
                    </div>
                    <div class="single-input">
                        <label for="editAddressLine">Address*</label>
                        <input type="text" id="editAddressLine" name="addressLine" class="form-control" placeholder="Enter Address" required>
                    </div>
                    <div class="single-input">
                        <label for="editCity">City*</label>
                        <input type="text" id="editCity" name="city" class="form-control" placeholder="Enter City" required>
                    </div>
                    <div class="single-input">
                        <label for="editState">State*</label>
                        <input type="text" name="state" id="editState" class="form-control" placeholder="Enter State" required>
                    </div>
                    <div class="single-input">
                        <label for="editCountry">Country*</label>
                        <input type="text" id="editCountry" name="country" class="form-control" placeholder="Enter Country" required>
                    </div>
                    <div class="single-input">
                        <button type="submit" class="btn btn-primary w-100">Update Address</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

    
</main>
<!-- Main Content Area End Here -->
<style>
    /* We only need minimal custom styles since we're using Bootstrap's modal */
    .modal-dialog {
      max-width: 500px;
    }
    
    .modal-header {
      border-bottom: 1px solid #eee;
      padding: 1rem 1.5rem;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .myaccount-form .single-input {
      margin-bottom: 1rem;
    }
    
    .myaccount-form label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .myaccount-form input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .myaccount-form input:focus {
      border-color: #666;
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    </style>
    
    <script>

    document.addEventListener('DOMContentLoaded', function () {
        // Edit Profile Modal
        const editProfileModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
        const editProfileButton = document.getElementById('editProfileButton');

        editProfileButton.addEventListener('click', function (e) {
            e.preventDefault();
            editProfileModal.show(); // Show the modal
        });

        const profileForm = document.getElementById('editProfileForm');
        profileForm.addEventListener('submit', function (e) {
            e.preventDefault();
            console.log('Profile form submitted!');
            // Add logic to save profile changes here
            editProfileModal.hide();
        });

        // Address Modal
        const addAddressModal = new bootstrap.Modal(document.getElementById('addAddressModal'));
        const editAddressModal = new bootstrap.Modal(document.getElementById('editAddressModal'));
        const addressList = document.getElementById('address-list');
        let editAddressId = null; // For tracking edit action

        // Add Address
        const addAddressButton = document.getElementById('addAddressButton');
        addAddressButton.addEventListener('click', function () {
            editAddressId = null; // Reset editing ID
            document.getElementById('addAddressForm').reset(); // Clear form
            addAddressModal.show();
        });

        document.getElementById('addAddressForm').addEventListener('submit', function (e) {
            e.preventDefault();
            console.log('Adding new address');
            // Logic to handle adding a new address
            addAddressModal.hide();
        });

        // Edit Address
        addressList.addEventListener('click', function (e) {
            if (e.target.classList.contains('edit-address-btn')) {
                editAddressId = e.target.dataset.id; // Set edit ID
                console.log(`Editing address with ID: ${editAddressId}`);
                // Populate the form with the selected address's data here
                editAddressModal.show();
            }
        });

        document.getElementById('editAddressForm').addEventListener('submit', function (e) {
            e.preventDefault();
            console.log(`Updating address with ID: ${editAddressId}`);
            // Logic to handle editing the address
            editAddressModal.hide();
        });
    });

    document.getElementById('addressForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch('/add-address', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            // Optionally append the new address to the UI
            const addressHtml = `
                <div class="col-12 col-md-6 mb-3">
                    <div class="address-card p-3 border rounded">
                        <h4 class="small-title">${data.addressType}</h4>
                        <address>
                            ${data.addressLine}, ${data.city}, ${data.state}, ${data.country}, ${data.pincode}
                        </address>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-primary btn-sm edit-address-btn">Edit</button>
                            <button class="btn btn-danger btn-sm delete-address-btn">Delete</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('address-list').innerHTML += addressHtml;
            document.getElementById('addressModal').reset();
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An unexpected error occurred. Please try again.');
    }
});

document.getElementById('editProfileForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch('/profile-update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            // Optionally, update the profile details on the page without a reload
            document.querySelector('#account-dashboard li:nth-child(1)').textContent = `Username: ${data.username}`;
            document.querySelector('#account-dashboard li:nth-child(3)').textContent = `Phone Number: ${data.number}`;
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An unexpected error occurred. Please try again.');
    }
});

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>    

<%- include("../partials/footer.ejs") %>