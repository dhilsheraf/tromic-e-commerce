<%- include("../partials/header.ejs") %>

<!-- Begin Main Content Area -->
<main class="main-content">
    <div class="breadcrumb-area breadcrumb-height" data-bg-image="/images/breadcrumb/bg/1-1-1920x400.jpg">
        <div class="container h-100">
            <div class="row h-100">
                <div class="col-lg-12">
                    <div class="breadcrumb-item text-night-rider">
                        <h2 class="breadcrumb-heading">My Account Page</h2>
                        <ul>
                            <li>
                                <a href="/">Home/</a>
                            </li>
                            <li>My Account</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="account-page-area section-space-y-axis-100">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <ul class="nav myaccount-tab-trigger" id="account-page-tab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="account-dashboard-tab" data-bs-toggle="tab" href="#account-dashboard" role="tab" aria-controls="account-dashboard" aria-selected="true">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="account-orders-tab" data-bs-toggle="tab" href="#account-orders" role="tab" aria-controls="account-orders" aria-selected="false">Orders</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="account-address-tab" data-bs-toggle="tab" href="#account-address" role="tab" aria-controls="account-address" aria-selected="false">Addresses</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="account-details-tab" data-bs-toggle="tab" href="#account-details" role="tab" aria-controls="account-details" aria-selected="false">Password</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="account-logout-tab" href="/logout" role="tab" aria-selected="false">Logout</a>
                        </li>
                        
                    </ul>
                </div>
                <div class="col-lg-9">
                    <div class="tab-content myaccount-tab-content" id="account-page-tab-content">
                        <div class="tab-pane fade show active" id="account-dashboard" role="tabpanel" aria-labelledby="account-dashboard-tab">
                            <div class="myaccount-dashboard text-center">
                                <p style="color: black;">Your account details:</p>
                                <ul>
                                    <li style="color: black;">Username: <%= user.username %></li>
                                    <li style="color: black;">Email: <%= user.email %></li>
                                    <li style="color: black;">Phone Number: <%= user.number %></li>
                                </ul>
                                <p>
                                    <br>
                                    <a href="#" id="editProfileButton" class="btn btn-custom-size lg-size btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">Edit Profile</a>
                                </p>
                            </div>
                        </div>                        
                        
                        <div class="tab-pane fade" id="account-orders" role="tabpanel" aria-labelledby="account-orders-tab">
                            <div class="myaccount-orders">
                                <h4 class="small-title">MY ORDERS</h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <tbody>
                                            <tr>
                                                <th>ORDER</th>
                                                <th>DATE</th>
                                                <th>STATUS</th>
                                                <th>TOTAL</th>
                                                <th></th>
                                            </tr>
                                            <tr>
                                                <td><a class="account-order-id" href="#">#5364</a></td>
                                                <td>Mar 27, 2019</td>
                                                <td>On Hold</td>
                                                <td>$162.00 for 2 items</td>
                                                <td><a href="#" class="btn btn-dark btn-primary-hover"><span>View</span></a>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><a class="account-order-id" href="#">#5356</a></td>
                                                <td>Mar 27, 2019</td>
                                                <td>On Hold</td>
                                                <td>$162.00 for 2 items</td>
                                                <td><a href="#" class="btn btn-dark btn-primary-hover"><span>View</span></a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="account-address" role="tabpanel" aria-labelledby="account-address-tab">
                            <div class="myaccount-address">
                                <p>The following addresses will be used on the checkout page by default.</p>
                                <div id="address-list" class="row">
                                    <!-- Dynamically render addresses here -->
                                    <% addresses.forEach(address => { %>
                                        <div class="col-12 col-md-6 mb-3">
                                            <div class="address-card p-3 border rounded">
                                                <h4 class="small-title"><%= address.addressType %> Address</h4>
                                                <address>
                                                    <strong>Full name:</strong> <%= address.name %><br>
                                                    <strong>Phone:</strong> <%= address.phone %><br>
                                                    <strong>Pincode:</strong> <%= address.pincode %><br>
                                                    <strong>Address:</strong> <%= address.addressLine %>, <%= address.pincode %>, <%= address.city %>, <%= address.state %>, <%= address.country %>
                                                </address>
                                                <div class="d-flex justify-content-between">
                                                    <button class="btn btn-primary btn-sm edit-address-btn" 
                                                    data-id="<%= address._id %>" 
                                                    data-name="<%= address.name %>"
                                                    data-phone="<%= address.phone %>"
                                                    data-address-line="<%= address.addressLine %>"
                                                    data-city="<%= address.city %>"
                                                    data-state="<%= address.state %>"
                                                    data-country="<%= address.country %>"
                                                    data-pincode="<%= address.pincode %>"
                                                    data-address-type="<%= address.addressType %>"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editAddressModal">Edit</button>
                                                
                                                    <button class="btn btn-danger btn-sm delete-address-btn" data-id="<%= address._id %>">Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                </div>
                                <button id="addAddressButton" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addAddressModal">Add Address</button>
                            </div>
                        </div>
                        
                        
                        <div class="tab-pane fade" id="account-details" role="tabpanel" aria-labelledby="account-details-tab">
                            <div class="myaccount-details">
                                <form action="#" class="myaccount-form">
                                    <div class="myaccount-form-inner">
                                        <div class="single-input">
                                            <label>Current Password</label>
                                            <input type="password" >
                                        </div>
                                        <div class="single-input">
                                            <label>New Password </label>
                                            <input type="password">
                                        </div>
                                        <div class="single-input">
                                            <label>Confirm New Password</label>
                                            <input type="password">
                                        </div>
                                        <div class="single-input">
                                            <button class="btn btn-custom-size lg-size btn-primary" type="submit">
                                                <span>SAVE CHANGES</span>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm" action="#" method="POST">
                        <div class="myaccount-form-inner">
                            <div class="single-input">
                                <label for="username">Username*</label>
                                <br>
                                <input type="text" class="form-control" id="username" name="username" value="<%= user.username %>" required>
                            </div>
                            <div class="single-input">
                                <label for="number">Phone Number</label>
                                <br>
                                <input type="text" class="form-control" id="number" name="number" value="<%= user.number %>">
                            </div>
                            <br>
                            <div class="single-input">
                                <button class="btn btn-custom-size lg-size btn-primary w-100" type="submit">
                                    <span>Save Changes</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>                
            </div>
        </div>
    </div>
    <!-- Address Modal -->
<!-- Modal for Add Address -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAddressForm">
                    <div class="single-input">
                        <label for="name">Full Name*</label>
                        <input type="text" name="name" id="name" class="form-control" placeholder="Enter Full Name" required>
                    </div>
                    <div class="single-input">
                        <label for="phone">Phone Number*</label>
                        <input type="text" name="phone" id="phone" class="form-control" placeholder="Enter Phone Number" required>
                    </div>
                    <div class="single-input">
                        <label for="addressType">Address Type*</label>
                        <select id="addressType" name="addressType" class="form-control" required>
                            <option value="Home">Home</option>
                            <option value="Work">Work</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="single-input">
                        <label for="pincode">Pincode*</label>
                        <input type="text" name="pincode" id="pincode" class="form-control" placeholder="Enter Pincode" required>
                    </div>
                    <div class="single-input">
                        <label for="addressLine">Address*</label>
                        <input type="text" id="addressLine" name="addressLine" class="form-control" placeholder="Enter Address" required>
                    </div>
                    <div class="single-input">
                        <label for="city">City*</label>
                        <input type="text" id="city" name="city" class="form-control" placeholder="Enter City" required>
                    </div>
                    <div class="single-input">
                        <label for="state">State*</label>
                        <input type="text" name="state" id="state" class="form-control" placeholder="Enter State" required>
                    </div>
                    <div class="single-input">
                        <label for="country">Country*</label>
                        <input type="text" id="country" name="country" class="form-control" placeholder="Enter Country" required>
                    </div>
                    <div class="single-input">
                        <button type="submit" class="btn btn-primary w-100">Save Address</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Edit Address -->
<!-- Edit Address Modal -->
<div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAddressForm">
                    <!-- Hidden field to store the addressId -->
                    <input type="hidden" id="editAddressId">

                    <div class="mb-3">
                        <label for="editName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPhone" class="form-label">Phone Number</label>
                        <input type="text" class="form-control" id="editPhone" value="" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAddressType" class="form-label">Address Type</label>
                        <select class="form-select" id="editAddressType" required>
                            <option value="Home">Home</option>
                            <option value="Work">Work</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editPincode" class="form-label">Pincode</label>
                        <input type="text" class="form-control" id="editPincode" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAddressLine" class="form-label">Address Line</label>
                        <input type="text" class="form-control" id="editAddressLine" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCity" class="form-label">City</label>
                        <input type="text" class="form-control" id="editCity" required>
                    </div>
                    <div class="mb-3">
                        <label for="editState" class="form-label">State</label>
                        <input type="text" class="form-control" id="editState" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCountry" class="form-label">Country</label>
                        <input type="text" class="form-control" id="editCountry" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>


    
</main>
<!-- Main Content Area End Here -->
<style>
    /* We only need minimal custom styles since we're using Bootstrap's modal */
    .modal-dialog {
      max-width: 500px;
    }
    
    .modal-header {
      border-bottom: 1px solid #eee;
      padding: 1rem 1.5rem;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .myaccount-form .single-input {
      margin-bottom: 1rem;
    }
    
    .myaccount-form label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .myaccount-form input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .myaccount-form input:focus {
      border-color: #666;
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    </style>
    
    <script>

document.addEventListener('DOMContentLoaded', () => {
    // Event delegation for dynamically loaded delete buttons
    document.addEventListener('click', function (event) {
        if (event.target.classList.contains('delete-address-btn')) {
            const addressId = event.target.getAttribute('data-id');

            // Confirm the deletion action with the user
            if (confirm('Are you sure you want to delete this address?')) {
                // Send the delete request to the server
                fetch(`/delete-address/${addressId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Address deleted successfully!');
                        // Remove the address card from the DOM
                        const addressCard = event.target.closest('.address-card');
                        if (addressCard) {
                            addressCard.remove();
                        }
                    } else {
                        alert(`Error deleting address: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the address. Please try again.');
                });
            }
        }
    });
});

          
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>    

<%- include("../partials/footer.ejs") %>